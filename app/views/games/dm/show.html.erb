<div class="game-play-container" data-controller="message-filter">
  <div class="game-info">
    <h1><%= @game.name %> - Game Control (Debug)</h1>
    <p class="text-muted">
      This is a debug interface for controlling the game. In the future, an AI agent will handle these DM functions.
    </p>

    <div class="character-impersonation mb-3">
      <h3>Character Views</h3>
      <p class="text-muted">Open character views in new windows to act as them:</p>
      <div class="character-links">
        <% @characters.each do |character| %>
          <div class="character-link-item mb-2">
            <%= link_to game_play_path(@game, character_id: character.id),
                        target: "_blank",
                        class: "btn btn-sm #{character.is_player? ? 'btn-primary' : 'btn-secondary'}" do %>
              Open as <%= character.name %>
              <% if character.is_player? %>
                <span class="badge badge-light">Player</span>
              <% end %>
              <% if character.area %>
                <small class="text-muted">(<%= character.area.name %>)</small>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="message-filter mb-3">
      <label>Filter Messages:</label>
      <select class="form-select" data-action="change->message-filter#filter">
        <option value="all">All Messages</option>
        <option value="private">Private Messages (No Area)</option>
        <% @areas.each do |area| %>
          <option value="area-<%= area.id %>"><%= area.name %></option>
        <% end %>
      </select>
    </div>
  </div>

  <%= turbo_stream_from "game_#{@game.id}_dm_messages" %>

  <div class="chat-container">
    <div id="messages" class="messages" data-controller="auto-scroll">
      <%= render partial: 'games/messages/message', collection: @messages, locals: { is_dm_view: true } %>
    </div>

    <div class="message-form">
      <%= form_with model: [@game, @message], url: game_dm_messages_path(@game), local: false,
                    data: { controller: "dm-message-form message-form" } do |f| %>
        <div class="form-group mb-2">
          <label>Send to:</label>
          <select name="message[target_type]" class="form-select" data-dm-message-form-target="targetSelect" data-action="change->dm-message-form#toggleTargetSelect">
            <option value="area">Area</option>
            <option value="character">Specific Character</option>
            <option value="all">All Characters</option>
          </select>
        </div>

        <div class="form-group mb-2" data-dm-message-form-target="areaSelect">
          <%= f.select :area_id, options_from_collection_for_select(@areas, :id, :name),
                       { include_blank: "Select an area" },
                       class: "form-select" %>
        </div>

        <div class="form-group mb-2 hidden" data-dm-message-form-target="characterSelect">
          <select name="message[target_character_id]" class="form-select">
            <option value="">Select a character</option>
            <% @characters.each do |character| %>
              <option value="<%= character.id %>">
                <%= character.name %><%= character.area ? " (#{character.area.name})" : " (No area)" %>
              </option>
            <% end %>
          </select>
        </div>

        <div class="form-group mb-2">
          <label>Message Type:</label>
          <%= f.select :message_type, options_for_select([["Chat", "chat"], ["System", "system"], ["Action", "action"]], "system"),
                       {}, class: "form-select" %>
        </div>

        <div class="input-group">
          <%= f.text_field :content,
                           class: "form-control",
                           placeholder: "Type your message...",
                           data: { controller: "message-form", action: "keydown.enter->message-form#submitOnEnter" } %>
          <%= f.submit "Send", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>