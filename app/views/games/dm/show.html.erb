<div class="game-play" data-controller="message-filter dm-message-form">
  <header class="game-header">
    <h1><%= @game.name %> - Game Control</h1>
    <div class="game-info">
      <span class="text-muted">DM interface for controlling the game</span>
      <button class="btn btn-sm btn-outline-secondary ms-3" data-action="click->dm-message-form#toggleImpersonation">
        <span data-dm-message-form-target="toggleText">Show Character Views</span>
      </button>
    </div>
    
    <div class="message-filter">
      <label>Filter Messages:</label>
      <select class="form-select" data-action="change->message-filter#filter">
        <option value="all">All Messages</option>
        <option value="private">Private Messages (No Area)</option>
        <% @areas.each do |area| %>
          <option value="area-<%= area.id %>"><%= area.name %></option>
        <% end %>
      </select>
    </div>
  </header>

  <div class="character-impersonation-wrapper hidden" data-dm-message-form-target="impersonationSection">
    <div class="character-impersonation">
      <h5>Character Views</h5>
      <p class="text-muted small">Open character views in new windows to act as them:</p>
      <div class="character-links">
        <% @characters.each do |character| %>
          <div class="d-inline-block me-2 mb-2">
            <%= link_to game_play_path(@game, character_id: character.id),
                        target: "_blank",
                        class: "btn btn-sm #{character.is_player? ? 'btn-primary' : 'btn-secondary'}" do %>
              <%= character.name %>
              <% if character.is_player? %>
                <span class="badge badge-light">Player</span>
              <% end %>
              <% if character.area %>
                <small>(<%= character.area.name %>)</small>
              <% end %>
            <% end %>
            <%= link_to "Edit", edit_game_character_path(@game, character),
                        class: "btn btn-sm btn-outline-dark",
                        target: "_blank" %>
          </div>
        <% end %>
      </div>

      <h5 class="mt-4">Areas</h5>
      <p class="text-muted small">Manage game areas:</p>
      <div class="area-links">
        <% @areas.each do |area| %>
          <div class="d-inline-block me-2 mb-2">
            <span class="btn btn-sm btn-info">
              <%= area.name %>
            </span>
            <%= link_to "Edit", edit_game_area_path(@game, area),
                        class: "btn btn-sm btn-outline-dark",
                        target: "_blank" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%= turbo_stream_from "game_#{@game.id}_dm_messages" %>

  <div class="chat-container">
    <div class="messages-container" id="messages" data-controller="auto-scroll">
      <% @messages.each do |message| %>
        <%= render "games/messages/message", message: message, is_dm_view: true %>
      <% end %>
    </div>

    <div class="message-form-container">
      <%= render "games/dm_messages/form", game: @game, message: @message %>
    </div>
  </div>

  <footer class="game-footer">
    <%= link_to "Back to Game", game_play_path(@game), class: "btn btn-primary" %>
    <%= link_to "All Games", games_path, class: "btn btn-secondary" %>
  </footer>
</div>