<div class="game-play-container">
  <div class="game-info">
    <h1><%= @game.name %> - DM Interface</h1>
    <p class="character-info">
      Dungeon Master: <strong><%= @dm_character.name %></strong>
    </p>
  </div>

  <div class="chat-container">
    <div id="messages" class="messages" data-controller="auto-scroll">
      <%= render @messages %>
    </div>

    <div class="message-form">
      <%= form_with model: [@game, @message], url: game_dm_messages_path(@game), local: false,
                    data: { controller: "message-form" } do |f| %>
        <div class="form-group mb-2">
          <label>Send to:</label>
          <select name="message[target_type]" class="form-select" data-action="change->message-form#toggleTargetSelect">
            <option value="area">Area</option>
            <option value="character">Specific Character</option>
            <option value="all">All Characters</option>
          </select>
        </div>

        <div class="form-group mb-2" data-message-form-target="areaSelect">
          <%= f.select :area_id, options_from_collection_for_select(@areas, :id, :name), 
                       { include_blank: "Select an area" }, 
                       class: "form-select" %>
        </div>

        <div class="form-group mb-2 d-none" data-message-form-target="characterSelect">
          <select name="message[target_character_id]" class="form-select">
            <option value="">Select a character</option>
            <% @characters.each do |character| %>
              <option value="<%= character.id %>">
                <%= character.name %><%= character.area ? " (#{character.area.name})" : " (No area)" %>
              </option>
            <% end %>
          </select>
        </div>

        <div class="form-group mb-2">
          <label>Message Type:</label>
          <%= f.select :message_type, options_for_select([["Chat", "chat"], ["System", "system"], ["Action", "action"]], "system"), 
                       {}, class: "form-select" %>
        </div>

        <div class="input-group">
          <%= f.text_field :content, 
                           class: "form-control", 
                           placeholder: "Type your message...",
                           data: { action: "keydown.enter->message-form#submit" } %>
          <%= f.submit "Send", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <%= turbo_stream_from "game_#{@game.id}_character_#{@dm_character.id}_messages" %>
</div>

<script>
document.addEventListener("turbo:load", () => {
  const controller = document.querySelector('[data-controller="message-form"]');
  if (controller) {
    const targetSelect = controller.querySelector('select[name="message[target_type]"]');
    const areaSelect = controller.querySelector('[data-message-form-target="areaSelect"]');
    const characterSelect = controller.querySelector('[data-message-form-target="characterSelect"]');
    
    targetSelect.addEventListener('change', (e) => {
      areaSelect.classList.add('d-none');
      characterSelect.classList.add('d-none');
      
      if (e.target.value === 'area') {
        areaSelect.classList.remove('d-none');
      } else if (e.target.value === 'character') {
        characterSelect.classList.remove('d-none');
      }
    });
  }
});
</script>