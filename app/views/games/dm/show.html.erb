<div class="game-play" data-controller="message-filter dm-message-form">
  <header class="game-header">
    <h1><%= @game.name %> - Game Control</h1>
    <div class="game-info">
      <span class="text-muted">DM interface for controlling the game</span>
    </div>

    <div class="character-impersonation mb-3">
      <h3>Character Views</h3>
      <p class="text-muted">Open character views in new windows to act as them:</p>
      <div class="character-links">
        <% @characters.each do |character| %>
          <div class="character-link-item mb-2">
            <%= link_to game_play_path(@game, character_id: character.id), 
                        target: "_blank", 
                        class: "btn btn-sm #{character.is_player? ? 'btn-primary' : 'btn-secondary'}" do %>
              Open as <%= character.name %>
              <% if character.is_player? %>
                <span class="badge badge-light">Player</span>
              <% end %>
              <% if character.area %>
                <small class="text-muted">(<%= character.area.name %>)</small>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
    
    <div class="dm-controls">
      <div class="dm-targeting">
        <div class="form-group mb-2">
          <label>Send to:</label>
          <select name="message[target_type]" class="form-select" data-dm-message-form-target="targetSelect" data-action="change->dm-message-form#toggleTargetSelect">
            <option value="area">Area</option>
            <option value="character">Specific Character</option>
            <option value="all">All Characters</option>
          </select>
        </div>

        <div class="form-group mb-2" data-dm-message-form-target="areaSelect">
          <select name="message[area_id]" class="form-select">
            <option value="">Select an area</option>
            <% @areas.each do |area| %>
              <option value="<%= area.id %>"><%= area.name %></option>
            <% end %>
          </select>
        </div>

        <div class="form-group mb-2 hidden" data-dm-message-form-target="characterSelect">
          <select name="message[target_character_id]" class="form-select">
            <option value="">Select a character</option>
            <% @characters.each do |character| %>
              <option value="<%= character.id %>">
                <%= character.name %><%= character.area ? " (#{character.area.name})" : " (No area)" %>
              </option>
            <% end %>
          </select>
        </div>
      </div>

      <div class="message-filter">
        <label>Filter Messages:</label>
        <select class="form-select" data-action="change->message-filter#filter">
          <option value="all">All Messages</option>
          <option value="private">Private Messages (No Area)</option>
          <% @areas.each do |area| %>
            <option value="area-<%= area.id %>"><%= area.name %></option>
          <% end %>
        </select>
      </div>
    </div>
  </header>

  <%= turbo_stream_from "game_#{@game.id}_dm_messages" %>

  <div class="chat-container">
    <div class="messages-container" id="messages" data-controller="auto-scroll">
      <% @messages.each do |message| %>
        <%= render "games/messages/message", message: message, is_dm_view: true %>
      <% end %>
    </div>

    <div class="message-form-container">
      <%= render "games/dm_messages/form", game: @game, message: @message %>
    </div>
  </div>

  <footer class="game-footer">
    <%= link_to "Back to Game", game_play_path(@game), class: "btn btn-primary" %>
    <%= link_to "All Games", games_path, class: "btn btn-secondary" %>
  </footer>
</div>